# 이기프트배송 에러 및 해결 정리



[toc]



#### 결제 실패

현상

>\- 접수일시 : 2021-08-05 20:02
>
>\- SR카드+모바일상품권2종+E GIFT ITEM 2종 복합결제시 결제를 진행할 수 없음
>
>\- 주문번호 : D2021080519464611335
>
>\- 고객id : WBASO

원인 

>결제 금액과 결제수단별 금액 합산이 안맞아서 결제 실패가 떨어진 건입니다.
>정확한 원인은 로직 확인 및 해당 케이스 테스트를 통해 파악 해봐야 할 것 같습니다.
>차주에 이어서 확인 해보겠습니다.
>결제금액 : 32,000원
>결제수단별 금액 합산 : 32,600원
>
>
>sr카드 1200, 600 원 잔액 있었음

경과 및 해결방안

> 모바일 상품권 적용을 클릭 했을 때
> [최종 결제금액 = 총결제금액 - 모바일 상품권 사용금액 - 임직원 할인금액]
> 을 결제화면에 update하고 카드를 재 정렬 해야 SR API 로 보낼때 최종 결제금액을 기준으로 선택한 SR 카드에 맞추어 파라미터를 생성 할 수 있는데,
>
> 현재는 기존의 결제금액을 기준으로 SR 카드를 재정렬 하고 최종 결제금액을 update 하기 때문에 일어난 현상입니다.
>
> 최종 결제금액을 update하고나서 선택되야할 sr 카드를 조정하도록 로직을 수정했습니다.

참고자료

>주문 마스터
>
>select * from GS_ORDER_MSTR where user_id = 'WBASO';
>
>결제히스토리
>
>select * from GS_STLMN_CNTNT_HSTRY where dlvy_order_no = 'D2021080519464611335' 에서 확인하여 상태 확인했음.

#### SR카드 미노출

현상 

>\- 접수일시 : 2021-08-09 13:21
>
>\- 주문서에서 SR카드 미노출됨, 동일기종에서 다른 ID 로그인 시 SR카드 노출, 강성고객
>
>\- 고객서비스팀 확인 결과 결제 당시 SR카드 잔액 11,700원 추정 (4/14 후 11,700원이다가 8/8 자동충전 5만원 되어 8/9 오후 3시 현재 잔액 61,700원)
>
>Q. 배송하기 주문하려는데 결제가 안 됨
>내 계정에 대한 결제가 막혀있음
>핸드폰 기종에 대한 문제가 아니라며 강성 미수긍
>내 핸드폰으로 남편 계정 로그인 시 결제 부분이 뜸
>내 계정으로 로그인했을 때만 안 뜸
>이전 상담 시 상담원한테 로그인 해서 확인해달라고 했음
>상담원도 내 계정 로그인 시에 결제 부분이 안 뜬다고 함
>왜 내 계정에 대한 결제가 막혀있는 건지 의문임
>
>고객 id : jsmemsahib 

원인

> 우선 웹회원인데 SR카드 잔액이 있음(?) 휴먼 관련이라는데 SR측에 확인 필요.

 

#### 주문취소 실패

현상

> \- 접수일시 : 2021-08-09 15:05
>
> \- 취소실패메시지 뜨며 주문취소 실패함 (취소 실패했다는 메시지와 함께 고객센터로 연락하라는 문구가 뜸)
>
> \- 주문번호 : D2021080515034928264
>
> \- 고객 id : POOHFAMILY81

원인

> 2021-08-07 오후 01:04:11 에 /giftshop/paymentCancle 에 대한 확인 필요
>
> SR 카드와의 결제 api 에서 취소시에 실패하였음. 2개의 SR 카드를 사용하였는데 sbsCardNo = '6194696957788396' 의 sbcReaminAmt = -999 가 왜 음수 값인지 sr과 확인해봐야 할 것 같다.



#### 오랫동안 배송중 유지되는 건

추가로, VOC는 아니고 CBT기간 중 나온 케이스에 대해 문의드립니다.

주문번호 : D2021071823234816645 (동일주문건 內 송장번호 2개, 각각 배송완료/배송중 상태)

아직까지 배송중인 사유 확인 부탁드리며,

 

만약 택배사 분실이라고 가정한다면,

1) 고객이 배송받기를 원할 경우의 처리방법 – BO에 새로운 송장번호를 입력할 수 있는지

2) 고객이 취소하기를 원할 경우의 처리방법 – 배송중인 상태값을 수기로 배송완료로 바꾼 후 부분반품 가능한지 등  



#### 모의해킹 - 배송지 수정 



1.선물 받기화면(gift_receive.html)

인증하기(토큰 발급) 



2.배송지 등록 화면(guest_register.html) : 선물 받기화면에서 '배송지 입력하기' 버튼 누르면 호출됨

https://stg-www.starbucks.co.kr:3443/shipping/guest/register.do?dlvyOrderNo=D2021081110400655934&tokenKey=Cq9h6I%2FbdMALyJPXqXPjD%2FCgTWsPF9ssNOoeqPVvJBU%3D

배송지 입력하기(토큰, dlvyOrderNo 필요, tokenKey 필요) 

guest_register.html 에서 배송지 입력하기 버튼 누르면 shippingcontroller.java 의 /shipping/proc/guest/register.do 로 쏴서 userId 암호화 시킨다.



3.주문내역화면(order/shipping_info_guest.html) : 배송지 등록하기에서 '등록하기' 누르면 이동됨

https://stg-www.starbucks.co.kr:3443/order/guest/detail.do?headerType=TYPE4&dlvyOrderNo=D2021081110400655934&userId=20210811251592 : 초기 guest register로 이동한 주문내역 url

https://stg-www.starbucks.co.kr:3443/order/guest/detail.do?dlvyOrderNo=D2021081110400655934&userId=20210811251592&tokenKey=Cq9h6I%2FbdMALyJPXqXPjD%2FCgTWsPF9ssNOoeqPVvJBU%3D : 배송지 입력을 완료한 상태에서 주문 및 배송 조회를 눌렀을때의 url



querySTringparmeters (headerType, dlvyOrderNo, userId=시간?)

guest/detail.do 까지는 userId 가 일자로 랜덤하게 암호화 되어서 비정상 접근 어렵다.

우선 OrderListController 의 getOrderDetail 메소드에서 userId를 필수로 받고 token key 도 선택적으로 받고있는데(케이스 분류필요) tokenkey는 authCheckByDlvyOrderNo(dlbyno, token)에 의해 검증을거친다.

userID 의 경우

게스트로 접근했을때 @RequestMapping(value="/order/guest/detail.do", ) 로 접근할 때 afterOrdService.getOrderDetail에서 GOM.RCVR_ID = #{userID} 만족하는 것만 orderDetail 을 리턴한다.  userID 가 잘못되었으니 orderDetail이 null 값으로 리턴되어 AFT008 이라는 오류코드와 함께 에러를 나타내는 방식으로 검증하고 있다. 



이제 배송지 수정하기에서 userId 정보를 반드시 들고 있도록 하고 , shipping/guest/modify.do 에 접근할 때 userID 와 dlvyOrderNo 을 검증하는 로직이 없어서 현재 다른사람의 배송지 수정을 dlvyOrderNo 으로만 이용하여 바꿀 수 있다. 이를 주문내역에서 사용한 방식과 마찬가지로 체크하여 방어로직을 추가하였다. 



4.배송지 수정하기(shipping_address/modify_addr_guest) : 주문내역화면에서 '배송지 수정' 버튼 누르면 이동됨.(sbGSHistory 로 단순이동)

views/order/shipping_info.html | shipping_info_guest.html

https://stg-www.starbucks.co.kr:3443/shipping/guest/modify.do?dlvyOrderNo=D2021081110400655934&srnm=138&usrId=20210811251592&headerType=TYPE4

이 창으로 넘어올 때 userId가 틀려도 검증 로직이 없다. 

우선 guest/detail.do 에서 어떻게 userId를 검증하는지 알 필요가 있고 이를 배송지 수정하기에도 적용해야한다.



####  반품 승인(환불) 시 주문취소 실패 1건

현상

>안녕하세요. 신우균입니다.
>
>아래 반품 주문에 대해 반품 승인 처리 과정에서 최종 환불 처리 시 '주문취소실패' 되어 결제취소 처리를 요청드립니다.
>
>\- 주문번호 : D2021080517074001652
>
>\- 반품주문번호 : D2021081021190324230
>
>\- 주문상태 : 주문취소실패
>
>\- 반품승인일시 : 8월17일
>
>
>** bo 에서 분석한 내용 **
>
>D2021080517074001652 (상품 주문)
>
>주문 SR 카드 정상 결제 54000원 (8월 5일 오후 5시 7분)
>
>반품 취소 배송비 신용카드 정상 결제 6000원 (8월 10일 오후 9시 20분)
>
>D2021081021190324230(반품 주문)
>
>반품 승인 -> 주문취소 실패
>
>반품 승인을 함에 있어서 원래의 SR 카드가 환불이 안되는 현상 발생 했음.

원인1



>17일 17:15:11
>
>CancleServiceImpl.orderCancle 결제 마스터 정보 조회
>
>CancleServiceImpl.orderCancle 결제 상세 정보 조회
>
>CancleServiceImpl.orderCanclePayment 결제 취소 처리 : {}  

** orderCanclePayment 616 page + 에서 , 로 로그 고쳐야한다...

>17:15:11 까지는 잘된다. msrApiUtil.paymentCancle(paramMap) 에서 정상 param map을 넘겨죽 ㅗ있는거 확인했음.
>
>getMsrCancleService 의 resultString이 제대로 만들어지지 않는것을 확인하였다.
>
>**** 17:15:12 [DEBUG] ## MsrUtils.getMsrSrvice CALL END=====
>
>result : null
>
>
>17일 17:56:31, 18:10:37 
>/card/MyCardDetail
>
>paramMap : {refundCheckYN=N, cardRegNumber=24690916, userID=JHK2040},
>
>resultMap : {date=, resultCode=201, resultMessage=201|유효한 카드가 아닙니다., responseCode=200}
>

조치

>SR측에 문의
>
>
>
>17일 오후 5:15:12 에 SR에 고객에게 환불 승인을 위하여 요청을 하였고 이에 대한 응답으로 
>{data=null, resultCode=000, resultMessage=[시스템오류], responseCode=200OK} 가 왔습니다.



#### PG MSR 대사 차이

안녕하세요. 권영진 입니다.

이기프트 배송 서비스 관련하여 SR API 도중 에러가 발생한 건 들에 대하여 문의 드립니다.



1.반품 승인 결제 취소 

반품 주문에 대한 반품 승인처리 과정(SR카드로 결제한 원주문을 환불해주는 과정) 에 있어서 SR 통신 중 에러가 발생하여 문의 드립니다.

** 고객 아이디 : JHK2040 **

​	- API : giftshop/paymentCancel

​	- 호출일시 : 2021-08-17 17:15:12

응답 파라미터에 {data=null, resultCode=000, resultMessage=[시스템오류], responseCode=200OK}내용이 포함되어 있습니다.  그리고 그전에 고객의 SR 카드(cardRegNumber=24690916)가 유효한 카드가 아니라는 상태를 확인하였습니다.

​	- API : /card/MyCardDetail

​	- 호출일시 : 2021-08-17 17:14:30

응답 파라미터에 {resultMessage=201|유효한 카드가 아닙니다.} 가 포함되어있습니다.



2.  SR카드 미노출 고객 

접수일시 : 2021-08-09 13:21

고객에 해당하는 SR 카드 유형을 개발기나 스테이징에 발급이 가능한지 문의드립니다.

** 고객 아이디 : jsmemsahib

지난 번 문의 결과  정상 등록 되어있고 잔액도 정상인 것으로 확인 되었고 POSTMAN API 로는 정상적으로 값이 오는 것을 확인하였습니다. 하지만 동일 현상을 재현하기 어렵기 때문에 고객이 사용하고 있는 SR 카드 유형으로 발급을 요청드립니다.



3. MSR PG 대사 차이

정상 :이니시스 인증결제 -> 이니시스 승인 결제 -> MSR 결제(sr api) -> MSR 일반 취소

안되는 케이스 : 이니시스 인증결제 -> 이니시스 승인 결제 -> **이니시스 망취소** -> MSR 결제(sr api) -> **BO 이니시스 일반취소**



즉 이니시스에서 거래건 확인 시 망취소된 거래건으로 확인되었음. 이니시스측에서는 정상으로 판단 되었지만 스타벅스로부터 망취소요청이 인입되어 망취소 처리된 것으로 확인됨. 모바일 상품권이 노출 안된 부분을 확인해야한다.



다음 고객들의 SR 결제 관련 확인을 부탁드립니다.

상품 결제시에 SR api로부터 응답이 오지 않았고, 이에 따라 이니시스 망취소가 이루어 졌는데 취소 사유를 확인 부탁드립니다.  이니시스측에서는 정상으로 판단 되었지만 스타벅스로부터 망취소요청이 인입되어 망취소 처리되어 결제가 이루어지지 않은 건입니다. 

하지만, 이 주문이 정상 주문('결제완료')으로 인정되어 고객에게 노출이 된것으로 추측되고 (MSR 매출 발생, PG사 매출 미발생),  고객이 취소 요청을 했습니다. 고객이 취소 버튼을 눌렀을 때 이미 망취소가 되어 취소된 건이므로 '기 취소 거래' 사유로 이니시스 일반 취소(신용카드 취소)는 발생하지 않았습니다. 기프트 배송하기 상태는 '결제완료' 에서  '구매자 취소완료' 상태로 변경되었으나 여전히 MSR 매출은 발생한 상태로 남아있는 것으로 보입니다.

** 고객 아이디 : KKIMM89 (1건)

- API : /giftshop/payment

	- 호출일시 : 2021-08-12 오후 11:46:55 

** 고객 아이디 : JAEWOO0909 (2건)

	- API :  /giftshop/payment
	- 호출일시 : 2021-08-16 오전 12:21:55 , 오전 12:25:19



> 이기프트 배송 - SR 결제 API 관련 SR 측에서 답장 메일 왔습니다. 자세한 내용은 메일에 나와있습니다.
>
> 1. 반품 승인 결제 취소
>  수기 처리가 가능한지는 아직 확인중이며, 수기 처리 전에 스타벅스 현업과 현재 환불해야할 카드가 분실 신고후 삭제 처리되어 존재 하지 않는데 현업이 어떤 방향으로 처리를 원하는지 이야기 해보아야 합니다.
> => 수기처리로 새로운 카드를 만들어 환불을 해야하는지, 차주에 적용 후 변경해야하는지.
> => 새로운 카드를 만들어 환불로 수기 요청하는 것이 나아보임..
> 2. SR-PG 대사 차이 (모바일 상품권 미노출 되었던 주문)
> 두 고객 모두 SR 로부터 응답이 오지 않았는데, 이기프트 서비스가 아니여도 외부망(fo 웹뷰) 을 통해 api 통신 중 간헐적으로 발생한다고 합니다. 
> 대부분은 비정상 요청일 경우에 발생하게 되는데 JAEWOO0909 고객이 모바일 상품권 만료되었고 KKIMM89 고객의 모바일 상품권도 이미 사용된 것으로 보아 정상적인 결제 요청이 아닌 것으로 추측 됩니다.
>  => 요청 응답이 제대로 이루어지지 않는 것은 SR 과 외부망 통신때 발생하는 것이므로 지금 당장 해결하거나 원인을 알기는 어려워 보입니다.
> => 만료된 상품권이 제대로 검증 되지 않았으니 이와 관련하여 소스 확인 및 테스트를 해봐야 합니다.



SR 파트 문의 내용

>
>
>담당님 당장 급한일은 아니지만, 혹시 이런것도 확인이 가능하신가요?
>
>아까전에 답장주신 메일에서
>호출로그 확인 결과 : 결제실패 처리 ( 원인 : 모바일상품권 사용 실패(기간 만료) : 유효기간 2021-08-15 )
>로 로그가 찍혔다고 말씀해주셨는데 
>
>결제로직 들어가기전에 /giftshop/giftCertificateInfo 를 통해서 모바일 상품권이 유효한지 검증하는데 16일에 주문을 넣을때 왜 검증이 안됐나 고민하고 있습니다. 
>
>처음 의심했던 것은 해당 고객이 15일 밤에 상품권 인증을 성공하고 16일에 결제를 시도했다고 생각했는데 15일날 접속이력이 없더라구요.
>
>제가 확인을 하고자 요청하는 것은
>
>1. /giftshop/giftCertificateInfo API에 해당 모바일 상품권을 검증 요청을 15일에 보낸적 있는지 (해당 모바일 상품권 번호로 15일 api 요청이 있었는지)
>
>2. 15일에 없다면 16일에  /giftshop/giftCertificateInfo 를 통해서 모바일 상품권을 검증 했을 때 정상적인 상품권이라는 응답이 왔는지
>
>입니다.
>
>감사합니다.
>
>
>
>
>
>
>
> 



#### 고객 배송하기 결제 완료 시 오류코드:2701로 표기"건



#### 현금영수증 미노출 건

안녕하세요.

스타벅스 조유진입니다.

사진과 같이 현금영수증 정보 입력 칸이 노출이 안된다고 합니다.

 <img src="C:\Users\SSG\AppData\Roaming\Typora\typora-user-images\image-20210824172034336.png" alt="image-20210824172034336" style="zoom: 25%;" />

확인부탁드립니다.

> 해결완료 . 김나혜 담당님



#### SR 카드 분실신고 후 삭제 환불 건( 주문 취소 실패 )

현상, 원인, 조치

> 안녕하세요. 권영진 입니다.
>
> 
>
> 고객이 앱에서 주문 취소를 실행 했을 때 환불받아야할 SR 카드가 '분실신고 후 삭제 처리'되어 환급되지 못하는 이슈가 발생했습니다.
>
> 
>
> 해당 건 SR 파트와 공유하여 '분실신고 후 삭제 처리 SR카드' 에 대한 예외처리를 추가하여 금주 월요일(8/23)에 배포 예정이였으나 DR 앱에서 기프트 배송 서비스가 접속되지 않는 문제가 발생했습니다.
>
> 
>
> 금주 월요일(8/25) DR WEB 서버가 접속이 안되는 것으로 판단하여 방화벽 기안을 하였지만, 금일(8/25) 방화벽 허용 이후에도 처리가 되지 않았습니다. 
>
> 
> 원인은 방화벽이 아닌 DR 서버의 내부 DNS 가 등록되있지 않은 것으로 확인 되었고, DNS 등록 작업 이후 SR 배포가 이루어 질 수 있습니다.
>
> 
>
> 작업일은 ###로 예정되어 있으며 이후 SR 파트 배포가 완료되면 주문상태를 변경시켜 환불 절차를 진행할 수 있습니다.
>
> 감사합니다.



#### 배송요청 배치 안돌아가는 현상, 배송요청 수기처리 

현상

> 두건의 주문이 결제완료에서 배송요청 배치로 처리가 안되었음.

원인

> 원인은 파악하지 못했고, 데이터로 볼 떄 마스터는 배송요청으로 되었는데 상세가 업데이트 안된게 있는점을 봤을때 주문일시가  08:49:59, 3:09:59 인것으로 미루어 보아 배송요청 배치 1초전에 주문이 들어와 배치 작업중 꼬인게 아닐까 생각합니다.

조치

> 수기처리로 완료함.



#### 주문취소실패 (신용카드)

현상

> 19일 배포 이후로 주문취소시에 신용카드가 포함되면 주문취소 실패 에러가 발생함

원인

> 이니시스에서 결제취소 시 정의되지 않은 응답코드를 보내옴.
> 또한 에러에 대한 예외처리 메세지를 로그로 나타내지 않아 디버깅 하는데 시간이 오래 소요되었다.

조치

> 이니시스 프로그램에 변경사항이 있는지 확인 중, 선조치로 응답코드가 변하는 것에 유연하게 대응할 수 있도록 수정, 어제 저녁 7시 긴급배포 진행
>
> 추후 예외처리에 대한 로그 작성 필요

#### bo 주문취소 실패 메뉴 미노출 건

안녕하세요. 권영진 입니다.

**메일 수정 작업 중 순서가 뒤집혀서 다시 정정 메일 보냅니다.**



관련 문의 답장 드립니다.



**1) 잔여선수금증빙**

  \- 통영 일반 + 통영 제휴사 – 통영 E GIFT CARD 충전 = BO 선수금 – BO 취소 로 확인하고 있었는데요 (김산담당님이 알려주신 검증방법)

오류가 발생했고, 강제취소를 했음에도 불구하고 차액은 없더라구요. 차액이 없는 게 제 생각엔 이상한데, 사유 확인부탁드립니다.

\> 해당 건은 확인에 좀더 시간이 필요해서 추후 확인 한 후에 답변 드리겠습니다.

 

**2)** **주문실패관리 메뉴에는 없으나, 주문목록의 상태값에 주문취소실패로 뜨는 주문건의 처리방법**

  \- 주문목록에서는 주문취소실패라고 되어있으나, 주문실패관리 메뉴에 안뜨는 이유를 권영진담당님께 문의드렸었는데

주문취소실패를 했을 때 실제로 고객에게 돌려줄 돈이 있을 때만 주문실패관리 메뉴에 노출된다고 알려주셨습니다.

  

주문실패관리 메뉴에 없는 주문취소실패건은 취소일시가 적혀있어서, 고객에게 실제로 환불이 되었다고 말씀 주셨습니다.

  

그런데, SR ID : XCXC 66 고객이 구매한 2건의 주문의 경우, 기프티콘은 환불이 안되었다는 VOC가 들어왔는데요.

 

- 주문번호 : D2021082522555670631 -> 주문실패관리메뉴에 노출
- 주문번호 : D2021082523005447084 -> 주문실패관리메뉴에 미노출

  \> 어제 배포 이전에는 주문 취소 실패시 신용카드를 제외한 모바일 상품권은 환불되지 않았고 SR 파트를 통해서도 해당 내용 확인했습니다. 강제취소를 통하여 환불을 진행해야 합니다.







*** 주문실패관리 메뉴에 없는 주문취소실패건의 취소 일시에 대하여 \***

**
**

정상적으로 구매자 취소가 된 경우에는 '취소 완료' 가 되었을 때 '취소 일시' 가 나와있지만, 비정상적으로 주문 취소실패 경우에는 '취소 요청' 에서 중단 되었지만 '취소 일시' 가 노출되어 마치 실제로 취소가 완료된 것처럼 보여 혼란 을 겪었으리라 생각합니다.



**- 현재 상황**



\1. 구매자 결제 취소의 경우 (정상)



주문 상세의 '결제수단 상세'를 확인하면 모바일 상품권에 대한 **'취소완료'**, **'취소일시'**가 찍혀있습니다.



\2. 주문실패관리메뉴에 노출의 경우 (정상) - D2021082522555670631



주문 상세의 '결제수단 상세'를 확인하면 신용카드와 모바일 상품권에 대한 **'**결제성공', '승인일시'가 찍혀있습니다.



\3. 주문실패관리메뉴에 미노출 된 경우 (비정상) - D2021082523005447084



주문 상세의 '결제수단 상세'를 확인하면 신용카드와 모바일 상품권에 대한 **'취소요청'**, **'취소일시'**가 찍혀있습니다.



**- 원인**

**
**

bo 에서 주문관리의 결제수단 상세에서의 상태가 '취소요청' 일때에도 취소 요청을 보낸 시간을 '취소일시'로 표기하여 노출되고 있습니다.



**- 해결 방안**

초기 코드 작성시 해당 케이스를 고려하지 못한 것으로 보이며, 취소 요청을 날렸음에도 취소가 되지 않았음을 고려하여 '취소 요청 일시' 로 표기하거나 '승인 일시'의 표기를 그대로 사용하여 bo 에서 혼란을 겪지 않도록 변경 해야할 것 같습니다. 해당 건은 코드 분석은 완료가 되었고 차주에 테스트 진행할 수 있습니다.



***** **BO 에서 주문실패 관리 메뉴에 미노출된 경우에 대하여** *****



**- 원인**

주문실패관리에는 실제로 고객에게 돌려줄 돈이 잇을 때에 노출 되어야 하는 것이 맞습니다.
해당 미노출 건은 소스코드 확인 결과 주문 상태가 '취소요청' 인것을 바라보지 않고 있기 때문에 일어난 현상입니다.



기존 로직 작성시에 취소요청시 실패하는 케이스는 고려하지 못한 것으로 보이며 DB 조회 결과 현재 총 2건 있는 걸로 확인되었습니다. (D2021082523005447084, D2D2021082420031570267)



**- 해결방안**

현재 주문실패 관리에 취소 요청이 포함되도록 쿼리를 수정할 수 있습니다. 하지만 '취소요청' 상태가 취소가 완료되기 전까지 유지되어야 하는 상태인데 정상적인 주문 건이 주문실패관리에 일시적으로 노출될 수 있는 영향이 있습니다. ( 정상 취소가 된다면 아주 잠깐의 시간이므로 큰 영향은 없을 것으로 보임. )

취소 요청 된 주문이 주문취소실패 메뉴에 안뜬 경우가 2건이므로 우선은 해당 주문은 주문관리에서의 강제취소로 처리하고 이후에 케이스가 더 발생하면 그때 쿼리를 수정하는 것이 더 안전하다고 판단됩니다.



#### 신용카드 주문취소실패 PG 대사 수기 정산 작업

요청

> 안녕하세요? 유재희 담당입니다.
>
> 
>
> 신용카드 결제취소 이슈로 인해 PG 대사 차이가 많이 발생 했습니다. (43건)
>
> 금일내로 처리 하려고 했으나 오류로 인해 취소 관련 히스토리가 없어 해당 내용은 이니시스에 요청한 상태입니다.
>
> 
>
> \1. 통영 DB 접속 정보
>
>  \- Host : 10.103.48.22
>
>  \- Port : 1521
>
>  \- SID : SCKMIS2
>
>  \- 계정 : SCKSA/scksa_pass
>
> 
>
> \2. 통영 테이블 : MSR.MSR500_SUB (SCKSC 에 있음)
>
> 
>
> \3. 보정 내용
>
>  \- [SLM0005070] 이니시스 대사 화면에서 결제구분 값 [e-Gift 배송] 선택 후 조회 시 43건 조회되는데 1건도 조회되면 안 됨
>
>  \- 결제 승인/취소 데이터는 한쌍으로 존재해야하며 당일 취소인 경우 TODY_DLNG_CNCLT_YN 컬럼 값을 Y로 업데이트 쳐야함 (승인/취소 모두)
>
>  \- 43건 모두 [주문취소실패], [구매자 결제 취소] 상태로 확인됨
>
>  \- 43건 모두 신용카드 취소는 이루어졌으나 오류로 인해 취소일시가 없어 이니시스에 요청함
>
>  \- 취소일시 이니시스로 부터 전달 받으면 당일 취소여부 확인 후 취소 데이터를 통영 테이블에 직접 INSERT 하던가
>
>   BO 결제 테이블 DLNG_CNCLT_DTM 컬럼 업데이트 후 익일 통영 배치 수행 후 통영 데이터 수정 해야함
>
>   (STATUS 값 S : 승인, C : 취소)
>
> 
>
> ※ 산담당님 문의 결과 이렇게 분석되긴 했는데 조치 후 산담당님 컨펌 받아보시는게 좋을듯싶어요.
>
>   작업중 모르는 내용 있으면 산담당님께 도움 요청 하시고 필요하면 저한테도 연락 주세요.
>
>   그나마 다행인건 지난번처럼 통영 데이터 삭제하는건 아니라 BO 집계 테이블 수정은 안해도 될듯(?)
>
>   김동우 파트너 보기 전에 미리 다 보정해놓으려고 했는데 이미 봐버림;;;;

조치

> 해당 DB 테이블 들어가서 익일/ 당일 취소 구분하여 Cancle 에 해당하는 row 를 만들어서 Insert 해서 대사를 맞추었다.



#### 선물받기화면 메세지 카드 미노출 

현상

> 선물받기 화면에 가면 빈페이지가 나오면서 exception 발생시킨다.

원인

> 현재 sr api 에 https://msr.istarbucks.co.kr:6443/webif/giftshop/msgCardList? 를 사용하고 있는데 시즌이 지나거나 특정이유로 사용하지 않는 카드들은 null 값으로 받아와서 에러 발생. 

조치

> 기프트샵 : 파라미터에 useFlag 를 포함시켜 시즌이 종료된 카드들도 불러올 수 있도록 수정할 예정
>
> 선물 하기(sendgift) 할때 useFlag=Y를 포함시키고 받을때는 그대로 안보내도록 수정
>
> SR : 쿼리 수정 예정

AS-IS

<img src="C:\Users\SSG.IC0-W-N12094\AppData\Roaming\Typora\typora-user-images\image-20210915104232764.png" alt="image-20210915104232764" style="zoom:50%;" />



<img src="C:\Users\SSG.IC0-W-N12094\AppData\Roaming\Typora\typora-user-images\image-20210915104238269.png" alt="image-20210915104238269" style="zoom:50%;" />

TO-BE

<img src="C:\Users\SSG.IC0-W-N12094\AppData\Roaming\Typora\typora-user-images\image-20210915104256748.png" alt="image-20210915104256748" style="zoom:33%;" />



<img src="C:\Users\SSG.IC0-W-N12094\AppData\Roaming\Typora\typora-user-images\image-20210915104302396.png" alt="image-20210915104302396" style="zoom:33%;" />





업무방 공유메세지

[공유] 기프트배송 WAS OLIVE exception 증가 관련 내용 공유 드립니다.

- 이슈내용 : 9/7 기프트배송(olive) exception 건수 : [933]건, [873]증가▲
- 원인 : 선물 받기 화면에서 현재 사용하지 않은 메세지 카드를 api로 요청하여 Exception 발생 ( 시즌이 바뀌며 메세지카드 미사용 처리 )
- 조치 방향 : 
  1. 기프트 배송 : 현재 사용하지 않는 메세지카드도 조회할 수 있도록 API 에 파라미터 추가
  2. SR : 파라미터에 따라서 미사용 카드 조회 가능하도록 쿼리 수정 

해당 내용 스테이징 테스트 이후 차주 배포 진행하겠습니다.



#### 배송비 계산 로직 오류 건(결제 실패 건) - 20210914 완료

현상

> OJY70 고객이 결제하기가 안되는현상발생. DB, log 안남음

원인

> 배송비 계산 로직에서 (main.html) 배송비 계산이 임직원, 일반고객 계산로직이 구분 되어있는데 일반고객의 배송비를 계산하는 부분에서 초기에는 상품가격으로 배송비를 계산하나 refresh 해줄 때 (상품가격 + 배송비) 를 기준으로 배송비를 다시 계산해서 발생하는 문제

조치 

> 배송비 계산 로직의 staticPrice( 상품가격 + 배송비 ) 기준을 totalProdtAmt (상품가격) 으로 변경 시켰다.



#### A JsonObject text must begin with '{'

현상

> 교환시에 (05) 중복키 오류 발생

원인

> 인벤에서 중복키시에 replace into 나 duplicate key udpate 해줘야한다.



#### 반품 이후 재 반품시에 이전 결제가 취소가 되지 않는 현상

현상

> 복수 상품을 구매했을때 하나의 반품완료 이후 다른 상품을 반품 승인 하였을 때 이전 결제가 '취소예정' 상태에 머무르고 '취소완료'로 변하지 않음.

원인 

> 이전 결제 정보를 참조하기 위해서는 재결제 데이터가 있어야 하는데 판매자 귀책일 경우 상품 결제정보가 null 이므로 원결제를 찾지 못하는 경우가 발생한다.

조치

> 결제정보를 결제 데이터가 없을때도 생성해서 삽입해야한다.
>
> 결제성공(00) 상태 삽입해서 해결하였음.



#### 구매확정 후 반품시 텀블러 쿠폰 회수 안되는 현상

현상 예시

D2021102908073609154

- bo 주문관리탭

> 주문번호 D2021110409261620532
>
> 오로라 글라스 콜드컵 2개
>
> 쿠폰1 (51183258965200234) : 발송 Y, 회수 N, 사용 Y 
>
> 쿠폰2 (51183258974200234) :발송 Y, 회수 N, 사용 N
>
> 블랙 사이렌 콜드컵
>
> 쿠폰1(51183258956200234) : 발송 Y, 회수 N, 사용 N
>
> 
>
> ### bo 쿠폰발송내역
>
> 51183258965200234 (80810525) : 회수완료 -> 사용완료 바꾸자!
>
> 51183258974200234 (56469575): 발급완료
>
> 51183258956200234 (88022963) : 발급완료
>
> 
>
> ### msr 어드민 영수증 쿠폰 발행 조회
>
> 51183258965200234 (80810525) => [0202251165482](javascript:cfn_couponInfoDetail('0202251165482');void(0);)  : e쿠폰등록됨
>
> 51183258974200234 (56469575) : 아직 e 쿠폰 발급 안되었음
>
> 51183258956200234 (88022963) => [0202251165497](javascript:cfn_couponInfoDetail('0202251165497');void(0);) : e쿠폰등록됨
>
> 
>
> ### msr 어드민 쿠폰 발행 조회
>
> 51183258965200234 (80810525) => [0202251165482](javascript:cfn_couponInfoDetail('0202251165482');void(0);)  : 사용 완료
>
> X
>
> 51183258956200234 (88022963) => [0202251165497](javascript:cfn_couponInfoDetail('0202251165497');void(0);)  : 현재 발행 상태
>
> 
>
> 문제점.. SR 에는 91로 사용완료된 쿠폰을 회수 할 수 없다는 에러를 주는데 우리쪽에선 예외처리하고 있지 않음.

조치

> 텀쿠 회수시 쿼리문 수정하였음.
>
> 회수할 대상이 없을 때의 상태필요하다



추가 참고 사항

> 텀블러 쿠폰 관련 확인해야할 사항
>
> 1\. FO 배지 표시 여부 
>
> 현재 FO 에서 텀쿠 개수에 따른 UI 로직 어떻게 되어있는지 확인하기
>
> 고려사항 
>
> 발급완료(02) -> 회수완료(03) 일때는 쿠폰이 회수되면서 뱃지도 사라진다. 그렇다면 
>
> 발급완료(02) -> 사용완료(04) 일때 UI 표시해야하는지 여부
>
> 
>
> 2\. BO 주문상세 쿠폰 현황 조회
>
> BO 에서 주문상세 가면 발급/회수/사용 여부를 sr 에 api 로 확인할 수 있다. 
>
> 발급된 텀쿠는 종이쿠폰상태이고 이게 등록할때 e-ticket 으로 변환되어 발급여부를 확인할 수 있는 것같다.
>
> 이대로 유지하는 것이 맞는지. 일단 위에 사항이 맞는지 사실 확인 필요

대화 내용

>조유진 파트너님은 쿠폰이 정상회수가 되지 않았는데(사용완료이므로) 회수처리가 되어 뱃지가 사라진다고 하였음. 아마 주문내역이 유사한게 많아 착각한 것으로 보임. 하나 회수해도 하나 남아있으면 뱃지 살아있었을 것같다. 추가 확인 필요
>
>

메세지카드 한글 깨짐현상

현상 

> 고객이 선물카드를 보내는데 메세지카드가 인코딩이 꺠지는 현상이 발현된다. 그래서 SQL 길이 초과 및 VOC 발생

원인 

>→ 원인 분석 : [sendGiftCard.do](http://sendGiftCard.do) -> payment/[main.do](http://main.do) 에서 세션이 끊기면서 MoveLogin을 호출해서 (api/[login.do](http://login.do)) 다시 payment/[main.do](http://main.do) 로 이동되면서 기존에 없던 queryString 이 추가되고 , 꺠진 글자가 parameter에 포함된다.

조치

>→ 1단계조치 : 500 byte, 15 byte 잘라서 배포 하였음.
>
>→ 마지막문자가 특수문자나 깨진 글자일때는 바이트 기준으로 자르고 다시 문자열로 바꾸면 깨진물자가 3byte로 인식되어 497 byte,12 byte 로 짤라야한다.

조치2

>
>
>1. SessionInterception > Prehandle 에서 세션끊기면 moveLoginPage 으로 함수가 호출되면서 메세지와 같은 파라미터들이 인코딩되고 payment.do 로 forwarding 됨.
>
>2. forwarding 되면서 메세지가 queryString으로 변환되는데 이게 paymentController 에서 DTO 로 변환되는 과정에서 인코딩이 깨짐. (UTF 8 -> ISO-8859-1)
>
>3. queryString -> DTO 변환될때 그냥 디코딩을 하고싶은데 이건 어떻게하는지 모르겠어서 paymentController 에서 moveLoginPage 들렸다가 오면 그냥 강제 인코딩 해줬음(ISO-8859-1 -> UTF-8)



#### 한글 id 문제

[ 한글아이디 공유 ] 
DEV - 아키니루 / tlstprP3$%
STG - 지뇨이이이잉2 / tlstprP1@#

원인

> FO 에서는 인코딩 설정 mapToqueryString build false 하여 한글 파라미터를 body에 그대로 sr 에 보내어 해결하였지만 , BO에서 별지급 처리를 할때 주문테이블로부터 구매자명을 가져와 별지급 테이블에 INSERT 를 하게되는데, 이떄 DB 설정이 US7ASCII 로 되어있다. US7ASCII 캐릭터셋 사용 시에는 한글이 VARCHAR2 column에 들어갈 수 없다. 



#### 통영 MSR대사 , PG대사 케이스 1

안녕하세요.

재무관리팀 김동우_세븐 입니다.

 

아래와 같이 대사 차이 발견 되었습니다.

해당건 오늘 내 정리될수 있도록 즉시 확인 요청드립니다.

 

또한 오늘 추가 차이가 발생하지 않도록 모니터링 요청드립니다.

| **No** | **거래일자** | **입금일자** | **결제구분** | **결제수단** | **매입사** | **TID**                                  | **누락상태** | **승인번호** | **MSR** | **PG****사** | **차액정보** |
| ------ | ------------ | ------------ | ------------ | ------------ | ---------- | ---------------------------------------- | ------------ | ------------ | ------- | ------------ | ------------ |
| 5      | 2021-12-29   | 2022-01-05   | e-Gift 배송  | 신용카드     | 롯데카드   | INIMX_CARDistarbuc0520211229235532765744 | MSR 누락     | 62232113     | 0       | 3,700        | -3,700       |
| 6      | 2021-12-30   | 2022-01-06   | 사이렌오더   | 신용카드     |            | INIMX_CARDistarbuc0220211230113515525065 | MSR 누락     |              | 0       | 10,100       | -10,100      |

Q. 12-29 거래일자로 MSR누락이 발생하였는데요. PG사 3,700 원 , 차액정보 -3,700 원이란 의미가 무엇인가요 ? (12/31 에 수동으로 결제취소 하였음 롯데카드 + 모상)

A. pg에는 3700원 결제상태로 남아있고 sr에는 없는것이다. 
1.sr은 결제 - 결제취소되어서 없는거일수도있다.
2.pg만 결제되어서 아예 sr 결제데이터가 없는 것일 수 도있다.

pg취소요청된거면 취소 후에 sr에 데이터 넘어오므로 취소요청을 하였다고 회신하면된다.

Q. 저는 대사가 있는걸 통영 -> PG정산관리 -> 이니시스 대사 에서 확인하는데 MSR.MSR500_SUB 에 해당 데이터가없다. 무슨의미?

A. 이니시스 대사는 하는일이 영업정보 pg 테이블이랑 MSR.MSR500_SUB 이거랑 대사를 한다. MSR.MSR500_SUB  여기에 데이터가 없어서 저렇게 대사로 나온 것이다. 즉,  pg 결제만 된 케이스일 수 있다. pg 취소 처리하였다고 강동우 파트너에게 내용 공유하면 됨.

결론. 보통 msr500_sub에 데이터가 없는 경우가 pg 결제만 된 케이스 인데 이건 내부적으로 검토해보아야한다.



#### 배송상품일별집계 쿼리 튜닝

현상 

> 배송상품 일별집계가 1월 1일부터 돌지 않았음

원인

> none

조치 

> From 김산.
>
> PM님 번거로우시겠지만
> 기술지원팀 김진형님 께 메일로 이내용 요청주시면 
> 기술지원팀 전문 튜너분이 보실꺼에요 ㅎㅎ
>
> 참조로 이대한, 기술지원팀 송병곤팀장님
>
> 이렇게 보내주시고
>
> DB 성능확인은 DR에서 가능하니까 
> DR DB에서 확인바란다고 메일좀 주세요.
>
> SQL 성능이슈 또는 점검요청도 가능해요

앞으로 전봉준님에게 요청안하고 기술지원팀 김진형님에게(튜너) 요청하면된다.



#### 에러증가 공유 메세지

[Gift배송] 2/8 500에러 및 Exception 증가 원인 공유드립니다.
- 케이스티파이로 인해 주문량 급증하여 (약 10배) 기존에 발생하던 500에러, Exception 같이 증가한 것으로 보입니다. (화면단 오류)
- 2/7 주문 건수 : 486건
- 2/8 주문 건수 : 5,084건















 

















